# Root Detection Bypass & Malware Analysis Setup

## Physical Device Preparation

### Initial Setup
```bash
# Enable USB debugging
adb devices
adb shell settings put global development_settings_enabled 1
adb shell settings put system accelerometer_rotation 0

# Install Magisk (from previous guide)
# Verify root access
adb shell su -c "whoami"
```

## Root Detection Bypass Tools

### 1. Magisk Hide (Built-in)
```bash
# Enable Magisk Hide
adb shell su -c "magisk --denylist enable"

# Add apps to denylist
adb shell su -c "magisk --denylist add com.bankapp.example"
adb shell su -c "magisk --denylist add com.target.app"

# List denied apps
adb shell su -c "magisk --denylist ls"
```

### 2. RootCloak Plus (Xposed Module)
```bash
# Install Xposed Framework via Magisk
# Download RootCloak Plus APK
curl -L -o rootcloak.apk "https://repo.xposed.info/module/com.devadvance.rootcloak2"

# Install via ADB
adb install rootcloak.apk
```

### 3. Hide My Applist (Advanced)
```bash
# Install HMA module
adb install hide_my_applist.apk

# Configure template for banking apps
adb shell su -c "am start -n com.tsng.hidemyapplist/.ui.MainActivity"
```

## Malware Analysis Setup

### 1. Frida Installation
```bash
# Install Frida tools on host
pip3 install frida-tools

# Download Frida server for device architecture
wget https://github.com/frida/frida/releases/download/16.1.4/frida-server-16.1.4-android-arm64.xz
unxz frida-server-16.1.4-android-arm64.xz

# Push to device
adb push frida-server-16.1.4-android-arm64 /data/local/tmp/frida-server
adb shell su -c "chmod 755 /data/local/tmp/frida-server"

# Start Frida server
adb shell su -c "/data/local/tmp/frida-server &"

# Verify connection
frida-ps -U
```

### 2. Analysis Environment
```bash
# Install analysis tools
adb install burpsuite_mobile_assistant.apk
adb install proxydroid.apk

# Set up proxy
adb shell settings put global http_proxy 192.168.1.100:8080

# Install SSL certificate
adb push burp_cert.crt /sdcard/
adb shell am start -a android.credentials.INSTALL
```

### 3. Monitoring Setup
```bash
# Install system monitoring
adb install systrace.apk
adb install network_log.apk

# Enable detailed logging
adb shell su -c "setprop log.tag.ActivityManager VERBOSE"
adb shell su -c "setprop log.tag.PackageManager DEBUG"
```

## Root Detection Testing Scripts

### Banking App Test
```javascript
// frida_root_bypass.js
Java.perform(function() {
    // Common root detection methods
    var RootBeer = Java.use("com.scottyab.rootbeer.RootBeer");
    RootBeer.isRooted.implementation = function() {
        console.log("[+] Root detection bypassed");
        return false;
    };
    
    // Su binary checks
    var Runtime = Java.use("java.lang.Runtime");
    Runtime.exec.overload("java.lang.String").implementation = function(cmd) {
        if (cmd.indexOf("su") != -1) {
            console.log("[+] Su command blocked: " + cmd);
            throw new Error("Command not found");
        }
        return this.exec(cmd);
    };
    
    // Build.TAGS check
    var Build = Java.use("android.os.Build");
    Build.TAGS.value = "release-keys";
});
```

### Usage:
```bash
# Run bypass script
frida -U -f com.target.bankingapp -l frida_root_bypass.js --no-pause

# Monitor network traffic
adb shell su -c "tcpdump -i any -w /sdcard/capture.pcap"

# Extract APK for analysis
adb shell pm path com.target.app
adb pull /data/app/com.target.app/base.apk
```

## Malware Analysis Workflow

### 1. Static Analysis
```bash
# APK analysis
aapt dump badging malware.apk
aapt list -a malware.apk

# Decompile
apktool d malware.apk
jadx malware.apk

# Strings analysis
strings malware.apk | grep -E "(http|crypto|root|admin)"
```

### 2. Dynamic Analysis
```bash
# Install malware in isolated profile
adb shell pm create-user --profileOf 0 test_user
adb shell am switch-user 10

# Monitor behavior
frida -U -f com.malware.sample -l monitor_all.js

# Capture system calls
adb shell su -c "strace -p $(pgrep malware) -o /sdcard/strace.log"
```

### 3. Network Analysis
```bash
# SSL pinning bypass
frida -U -f com.malware.sample -l ssl_bypass.js

# Capture traffic
mitmproxy --mode transparent --showhost
```

## Detection Evasion Techniques

### Environment Checks
- Disable USB debugging notifications
- Modify build properties
- Hide development settings
- Spoof device characteristics

### Process Hiding
```bash
# Hide processes from ps
echo "mount -o bind /system/bin/ps /system/bin/ps_original" > /system/etc/init.d/99hide
```

## Cleanup & Evidence Collection
```bash
# Collect logs
adb shell su -c "logcat -d" > analysis_logs.txt

# Export analysis data
adb pull /sdcard/frida_traces/
adb pull /sdcard/network_captures/

# Reset device state
adb shell am switch-user 0
adb shell pm remove-user 10
```

## Safety Considerations
- Use isolated test environment
- Document all modifications
- Maintain network isolation
- Regular device backups
- Proper evidence handling